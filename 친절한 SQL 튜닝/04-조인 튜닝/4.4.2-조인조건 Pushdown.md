# 조인조건 Pushdown 기능

## 개요

조인조건 Pushdown은 데이터베이스 쿼리 최적화 기법 중 하나이다.     
조인 연산을 수행하기 전에 조인 조건을 데이터 소스에 미리 적용하여 처리해야 할 데이터의 양을 줄이는 방식이다.

## 동작 원리

일반적인 조인 연산에서는 두 테이블의 모든 데이터를 메모리로 가져온 후 조인 조건을 적용한다.      
하지만 조인조건 Pushdown을 사용하면 데이터를 가져오는 단계에서 이미 필터링이 적용되어 네트워크 전송량과 메모리 사용량을 크게 줄일 수 있다.

### 기본 프로세스

1. 쿼리 옵티마이저가 조인 조건을 분석한다
2. 조인 조건 중 특정 테이블에만 관련된 조건을 식별한다
3. 해당 조건을 데이터 소스 레벨로 내려보낸다(Push down)
4. 데이터 소스에서 필터링된 결과만 반환한다
5. 줄어든 데이터셋으로 조인을 수행한다

## 예시

### Pushdown 적용 전

```sql
SELECT o.order_id, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';
```

**실행 과정:**
1. orders 테이블의 모든 데이터를 읽는다
2. customers 테이블의 모든 데이터를 읽는다
3. 두 테이블을 조인한다
4. 조인 결과에서 `order_date >= '2024-01-01'` 조건을 적용한다

### Pushdown 적용 후

```sql
SELECT o.order_id, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';
```

**실행 과정:**
1. orders 테이블에서 `order_date >= '2024-01-01'` 조건을 만족하는 데이터만 읽는다
2. 필터링된 orders의 customer_id 목록을 기반으로 customers 테이블에서 필요한 데이터만 읽는다
3. 이미 필터링된 데이터끼리 조인한다

## 성능 비교표

| 구분 | Pushdown 미적용 | Pushdown 적용 | 개선율 |
|------|----------------|--------------|--------|
| 읽은 데이터량 | 1,000,000 rows | 50,000 rows | 95% 감소 |
| 네트워크 전송량 | 500 MB | 25 MB | 95% 감소 |
| 메모리 사용량 | 800 MB | 40 MB | 95% 감소 |
| 쿼리 실행 시간 | 45초 | 2.3초 | 94.9% 단축 |

## 적용 가능한 조건

### Pushdown이 가능한 경우

- 단일 테이블에 대한 필터 조건
- 상수 비교 연산 (=, >, <, >=, <=, !=)
- IN, BETWEEN 연산자
- 단순한 논리 연산 (AND, OR)

### Pushdown이 불가능한 경우

- 여러 테이블을 참조하는 복잡한 조건
- 서브쿼리를 포함하는 조건
- 사용자 정의 함수가 포함된 조건
- 집계 함수가 포함된 조건

## 실제 적용 시나리오

### 시나리오 1: 대용량 로그 분석

```sql
-- 전체 로그에서 특정 사용자의 최근 활동 조회
SELECT l.log_id, u.username, l.action
FROM logs l
JOIN users u ON l.user_id = u.user_id
WHERE l.created_at >= DATEADD(day, -7, GETDATE())
  AND u.status = 'active';
```

**효과:** 수백만 건의 로그 중 최근 7일 데이터만 먼저 필터링하여 조인 대상을 대폭 감소시킨다.

### 시나리오 2: 분산 데이터베이스 조인

```sql
-- 여러 지역 데이터센터의 주문 정보 통합
SELECT o.order_id, p.product_name
FROM remote_orders o
JOIN products p ON o.product_id = p.product_id
WHERE o.region = 'ASIA'
  AND o.status = 'completed';
```

**효과:** 원격 데이터베이스에서 필요한 데이터만 가져와 네트워크 비용을 최소화한다.

## 데이터베이스별 지원 현황

| 데이터베이스 | 지원 여부 | 특징 |
|------------|----------|------|
| Oracle | 지원 | 자동 최적화 및 힌트 제공 |
| PostgreSQL | 지원 | Foreign Data Wrapper에서 활용 |
| MySQL | 부분 지원 | 버전 8.0 이상에서 개선 |
| SQL Server | 지원 | 쿼리 실행 계획에서 확인 가능 |
| Spark SQL | 지원 | Predicate Pushdown으로 구현 |
| Presto/Trino | 지원 | 커넥터별로 지원 범위 상이 |

## 최적화 팁

### 1. 인덱스 활용

Pushdown된 조건이 효과적으로 동작하려면 해당 컬럼에 적절한 인덱스가 필요하다.

```sql
-- 인덱스 생성 예시
CREATE INDEX idx_order_date ON orders(order_date);
CREATE INDEX idx_customer_status ON customers(status);
```

### 2. 통계 정보 최신화

쿼리 옵티마이저가 올바른 판단을 내리려면 최신 통계 정보가 필요하다.

```sql
-- 통계 정보 갱신
ANALYZE TABLE orders;
UPDATE STATISTICS customers;
```

### 3. 파티셔닝 활용

테이블 파티셔닝과 함께 사용하면 Pushdown 효과가 극대화된다.

```sql
-- 파티션 테이블 생성 예시
CREATE TABLE orders (
    order_id INT,
    order_date DATE,
    customer_id INT
)
PARTITION BY RANGE (order_date);
```

## 성능 모니터링

### 실행 계획 확인

```sql
-- PostgreSQL
EXPLAIN ANALYZE
SELECT o.order_id, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';

-- Oracle
EXPLAIN PLAN FOR
SELECT o.order_id, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';
```

### 주요 확인 사항

- Filter 단계가 Join 이전에 수행되는지 확인
- 읽은 행 수(rows)가 예상보다 적은지 확인
- 비용(cost) 값이 최적화 전보다 낮은지 확인

## 주의사항

1. **과도한 Pushdown은 역효과를 낼 수 있다**
   - 매우 선택적이지 않은 조건을 Pushdown하면 오히려 성능이 저하될 수 있다

2. **데이터 분포를 고려해야 한다**
   - 데이터가 균등하게 분포되지 않은 경우 예상과 다른 결과가 나올 수 있다

3. **최신 통계 정보 유지가 중요하다**
   - 오래된 통계 정보는 잘못된 최적화 결정을 유발한다

## 결론

조인조건 Pushdown은 대용량 데이터를 다루는 현대 데이터베이스 시스템에서 필수적인 최적화 기법이다. 특히 분산 환경이나 원격 데이터 소스를 다룰 때 그 효과가 극대화된다. 적절한 인덱스 설계와 통계 정보 관리를 통해 이 기능을 최대한 활용할 수 있다.
