# 트랜스포트 계층의 다중화와 역다중화

##  핵심 개념

다중화(Multiplexing)와 역다중화(Demultiplexing)는     
여러 애플리케이션이 동시에 네트워크를 사용할 수 있게 해주는 핵심 기능.

##  쉬운 비유

아파트 우편물 배달로 생각!

- 다중화: 여러 집(애플리케이션)의 편지를 하나의 우편함(네트워크)으로 모으는 과정
- 역다중화: 우편함에서 온 편지를 각 호수(포트번호)를 보고 정확한 집으로 배달하는 과정

##  다중화 (Multiplexing)

| 단계 | 설명 | 예시 |
|------|------|------|
| 1 | 여러 소켓에서 데이터 수집 | 크롬, 카카오톡, 게임이 동시에 데이터 전송 |
| 2 | 각 데이터에 포트번호 추가 | 크롬:443, 카카오톡:5050, 게임:8080 |
| 3 | 네트워크 계층으로 전달 | 하나의 IP 패킷으로 묶어서 전송 |

송신 측에서 일어남 

##  역다중화 (Demultiplexing)

| 단계 | 설명 | 예시 |
|------|------|------|
| 1 | 네트워크 계층에서 패킷 수신 | IP 패킷 도착 |
| 2 | 헤더의 목적지 포트번호 확인 | 포트 443번 확인 |
| 3 | 해당 포트의 소켓으로 전달 | 크롬 브라우저로 데이터 전달 |

수신 측에서 일어남 

##  실생활 예시

### 상황: 웹 서핑 중 음악 스트리밍

```
당신의 컴퓨터 (IP: 192.168.0.5)
├─ 크롬 브라우저 (포트: 54321) → 웹사이트 접속
└─ 스포티파이 (포트: 54322) → 음악 스트리밍

[다중화 과정]
크롬 데이터 (출발지: 54321) ─┐
                            ├─→ 네트워크로 전송
스포티파이 데이터 (출발지: 54322) ─┘

[역다중화 과정]
수신된 패킷들 ─→ 포트번호 확인 ─→ 해당 애플리케이션으로 분배
                 ├─ 포트 54321 → 크롬
                 └─ 포트 54322 → 스포티파이
```

##  포트번호의 역할

| 포트 범위 | 용도 | 예시 |
|----------|------|------|
| 0-1023 | 잘 알려진 포트 | HTTP(80), HTTPS(443), FTP(21) |
| 1024-49151 | 등록된 포트 | 특정 애플리케이션용 |
| 49152-65535 | 동적/임시 포트 | 클라이언트가 임시로 사용 |

##  TCP vs UDP 역다중화 차이

| 구분 | TCP | UDP |
|------|-----|-----|
| 식별 기준 | 4가지 정보<br>(출발지IP, 출발지포트,<br>목적지IP, 목적지포트) | 2가지 정보<br>(목적지IP, 목적지포트) |
| 연결 방식 | 연결 지향 (1:1 소켓) | 비연결 (1:N 가능) |
| 예시 | 웹 서버의 각 클라이언트마다<br>별도 소켓 생성 | DNS 서버 하나의 소켓으로<br>모든 요청 처리 |

## 핵심 정리

1. 다중화: 여러 애플리케이션 → 하나의 네트워크 (송신)
2. 역다중화: 하나의 네트워크 → 여러 애플리케이션 (수신)
3. 포트번호: 각 애플리케이션을 구분하는 "주소" 역할
4. 동시 실행: 여러 앱이 동시에 네트워크를 사용할 수 있는 이유!

이 메커니즘 덕분에 우리는 웹 서핑, 음악 감상, 메신저 사용을 동시에 할 수 있다.



##  헤더에 실제로 들어있는 정보

### TCP/UDP 헤더 모두 4가지 정보 포함

```
┌─────────────────────────────────┐
│   출발지 포트 (Source Port)      │  16비트
├─────────────────────────────────┤
│   목적지 포트 (Dest Port)        │  16비트
├─────────────────────────────────┤
│   ... (기타 헤더 정보)           │
└─────────────────────────────────┘

IP 헤더 (하위 계층)
┌─────────────────────────────────┐
│   출발지 IP (Source IP)          │
├─────────────────────────────────┤
│   목적지 IP (Dest IP)            │
└─────────────────────────────────┘
```

모든 패킷에는 항상 4가지 정보가 다 들어있다!
- 출발지 IP
- 출발지 포트
- 목적지 IP
- 목적지 포트

##  TCP vs UDP 역다중화 차이 (수정)

| 구분 | TCP | UDP |
|------|-----|-----|
| 소켓 식별에<br>사용하는 정보 | 4가지 전부<br>(출발지IP, 출발지포트,<br>목적지IP, 목적지포트) | 2가지만<br>(목적지IP, 목적지포트) |
| 의미 | 누가 보냈는지까지 구분 | 어디로 가는지만 구분 |
| 결과 | 같은 포트여도<br>클라이언트마다 다른 소켓 | 같은 포트면<br>항상 같은 소켓 |

##  구체적인 예시

### UDP의 경우

```
DNS 서버 (IP: 8.8.8.8, Port: 53)

클라이언트 A (192.168.0.5:12345) → DNS 서버
클라이언트 B (192.168.0.6:54321) → DNS 서버
클라이언트 C (192.168.0.5:12346) → DNS 서버

서버의 역다중화:
- 목적지 포트 53번만 확인
- 세 요청 모두 → 같은 소켓으로 전달!
- 소켓은 1개만 사용

응답 보낼 때:
- 받은 패킷의 출발지 IP와 포트를 보고
- 목적지로 바꿔서 응답
```

UDP 서버 소켓: "나는 53번 포트로 온 건 다 받아!"

### TCP의 경우

```
웹 서버 (IP: 1.2.3.4, Port: 80)

클라이언트 A (192.168.0.5:12345) → 웹 서버
클라이언트 B (192.168.0.6:54321) → 웹 서버
클라이언트 C (192.168.0.5:12346) → 웹 서버

서버의 역다중화:
- 4가지 정보 모두 확인
- 소켓 1: (192.168.0.5:12345 ↔ 1.2.3.4:80)
- 소켓 2: (192.168.0.6:54321 ↔ 1.2.3.4:80)
- 소켓 3: (192.168.0.5:12346 ↔ 1.2.3.4:80)
- 소켓 3개 사용!
```

TCP 서버 소켓: "80번 포트로 온 건 받지만, 누가 보냈는지에 따라 다른 소켓으로 처리해!"

## 🎯 핵심 차이점

### 질문하신 부분에 대한 답변

> "UDP에서 내 출발지 IP, port가 없으면 어떻게 작동해?"

- 헤더에는 항상 4가지 정보가 다 있음
- 차이는 "소켓을 찾을 때 뭘 보느냐"

### UDP
```
패킷 도착 → "목적지 포트만 확인" → 해당 소켓 찾기
응답 보낼 때 → "아까 받은 출발지를 목적지로" → 응답 전송
```

### TCP
```
패킷 도착 → "4가지 전부 확인" → 정확히 일치하는 소켓 찾기
이미 연결된 소켓이므로 응답은 자동으로 그 소켓으로
```

## 비유로 정리

| UDP (우체통) | TCP (택배) |
|-------------|-----------|
| 우체통 하나에 모든 편지 도착 | 각 고객마다 전담 배달원 배정 |
| 편지의 답장 주소 보고 답장 | 배달원이 고객 정보를 다 알고 있음 |
| "53번 우체통" 하나로 처리 | "A 고객 전담", "B 고객 전담" 구분 |

