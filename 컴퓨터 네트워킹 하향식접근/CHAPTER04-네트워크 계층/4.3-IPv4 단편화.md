# IPv4 단편화: 식별자, 플래그, 단편화 오프셋 

## 1. 개요

IPv4는 MTU를 초과하는 패킷을 전송할 때 단편화를 수행한다.       
단편화된 조각들은 목적지에서 다시 조립되어 원본 패킷을 복원한다.     
이를 위해 IPv4 헤더에는 식별자, 플래그, 단편화 오프셋 필드가 존재한다.

---

## 2. 식별자(Identification)

식별자는 단편화된 패킷 조각들이 동일한 원본 패킷에서 생성되었음을 구분하기 위한 16비트 값이다.
단편화된 모든 조각은 동일한 식별자 값을 가진다.
목적지는 출발지 IP, 도착지 IP, 프로토콜 번호와 함께 이 식별자를 이용하여 단편들을 하나의 그룹으로 묶는다.

---

## 3. 플래그(Flags)

플래그는 3비트로 구성되며 단편화 제어와 단편의 위치를 나타낸다.

| 비트 | 이름                 | 설명                                               |
| -- | ------------------ | ------------------------------------------------ |
| 0  | 예약                 | 사용하지 않음                                          |
| 1  | DF(Don't Fragment) | 단편화를 금지한다. 1이면 단편화를 수행할 수 없으며 MTU 초과 시 패킷을 폐기한다. |
| 2  | MF(More Fragments) | 후속 단편이 존재함을 의미한다. 1이면 중간 단편이며, 0이면 마지막 단편이다.     |

### DF(Don't Fragment)의 정확한 의미

* DF = 1
  단편화를 하면 안 된다. MTU보다 큰 패킷을 라우터가 받으면 조각내지 않고 바로 폐기한다.
  이후 ICMP "Fragmentation Needed" 메시지가 전송된다.
* DF = 0
  단편화를 허용한다. 필요하면 MTU에 맞게 조각을 생성할 수 있다.

DF는 단편화 여부를 표시하는 값이 아니라, **단편화를 허용할 것인지 금지할 것인지**를 나타내는 제어 플래그이다.

---

## 4. 단편화 오프셋(Fragment Offset)

단편화 오프셋은 해당 조각이 원본 패킷의 어느 위치에서 시작하는지를 나타낸다.
단위는 8바이트이다.
오프셋 값 × 8이 실제 데이터의 시작 위치가 된다.
목적지는 이 값을 기준으로 단편들을 올바른 위치에 배치한다.

---

## 5. 단편 재조립 과정

목적지 호스트는 다음 절차로 단편들을 재조립한다.

1. 동일한 식별자 값을 가진 조각들을 하나의 그룹으로 묶는다.
2. 각 조각의 MF 값을 확인한다.

   * MF=1: 뒤에 더 있는 조각
   * MF=0: 마지막 조각
3. 단편화 오프셋을 기준으로 원래 데이터 순서대로 배치한다.
4. 마지막 단편(MF=0)을 통해 전체 크기를 파악하고 원본 패킷을 완성한다.

---

## 6. 정리

식별자는 동일한 원본 패킷을 구분하는 역할을 한다.
플래그는 단편화 가능 여부(DF) 및 조각의 위치(MF)를 나타낸다.
단편화 오프셋은 원본 데이터에서의 위치를 명시한다.
이 세 필드는 단편화된 패킷을 목적지에서 정확하게 재조립하기 위한 핵심 요소이다.

---

